{% extends "base.html.jinja" %}
{% block body %}
    <h1>Credits</h1>
    <p>
        <span>
            {% if name %}
                Welcome, {{ name }}!
            {% else %}
                Welcome!
            {% endif %}
        </span>
        <span>Here are the credits you can claim—or have already claimed—for your ORCID profile.</span>
    </p>
    <div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <td>Credit</td>
                    <td>Claimed at</td>
                    <td>Actions</td>
                </tr>
            </thead>
            <tbody>
                {% for credit in credits %}
                    <tr>
                        <td>{{ credit["column.CREDIT_TYPE"] }}</td>
                        <td data-timestamp="{{ credit["column.CLAIMED_AT"] }}">{{ credit["column.CLAIMED_AT"] }}</td>
                        <td>
                            {% if credit["column.CLAIMED_AT"] %}
                                <span class="text-body-secondary">None</span>
                            {% else %}
                                <button type="button"
                                        class="btn btn-primary btn-sm"
                                        data-credit-type="{{ credit["column.CREDIT_TYPE"] }}"
                                        title="Apply this credit to your ORCID profile">
                                    <span class="spinner-border spinner-border-sm d-none" aria-hidden="true"></span>
                                    <span role="status">Claim</span>
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="4">There are no credits associated with this ORCID ID.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <script>
        /**
         * Invoke a function once the page—including all dependent resources (e.g. stylesheets, scripts)—has loaded.
         */
        window.addEventListener("load", () => {
            /**
             * Replaces the raw timestamps in the table, with timestamp strings in UTC.
             *
             * References:
             * - https://developer.mozilla.org/en-US/docs/Learn/HTML/Howto/Use_data_attributes#javascript_access
             */
            const formatTimestamps = () => {
                const els = document.querySelectorAll("[data-timestamp]");
                els.forEach(function (el) {
                    const timestamp = el.dataset.timestamp.trim();
                    if (timestamp.length > 0) {
                        const date = new Date(timestamp);
                        el.innerText = date.toUTCString();
                    } else {
                        el.innerText = "";
                    }
                });
            };

            /**
             * Sets up the buttons that can be used to claim a credit.
             */
            const setupClaimButtons = () => {
                const els = document.querySelectorAll("button[data-credit-type]");
                const url = "{{ url_for("post_credits_claim") }}";
                els.forEach(function (el) {
                    const creditType = el.dataset.creditType.trim();
                    el.addEventListener("click", async () => {
                        // Disable the button and reveal its spinner and alternative text.
                        el.setAttribute("disabled", ""); // creates the attribute (its value is irrelevant here)
                        el.querySelector("span.spinner-border").classList.remove("d-none");
                        el.querySelector("span[role='status']").innerText = "Claiming";

                        // FIXME: Implement final response handling and error handling. Currently a PoC.
                        try {
                            const response = await fetch(url, {
                                method: "POST",
                                headers: {"Content-Type": "application/json"},
                                body: JSON.stringify({credit_type: creditType}),
                            });
                            if (response.ok) {
                                const json = await response.json();
                                alert(JSON.stringify(json));
                            } else {
                                throw new Error(`Response status: ${response.status}`);
                            }
                        } catch (error) {
                            alert(error.message);
                        }

                        // Reset the button to its original state.
                        // TODO: Update the button according to the outcome of the claim action.
                        el.removeAttribute("disabled");
                        el.querySelector("span.spinner-border").classList.add("d-none");
                        el.querySelector("span[role='status']").innerText = "Claim";
                    });
                });
            };

            formatTimestamps();
            setupClaimButtons();
        });
    </script>
{% endblock %}
